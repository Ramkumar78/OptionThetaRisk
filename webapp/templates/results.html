{% extends "base.html" %}
{% block title %}Results - Option Auditor{% endblock %}

{% block content %}
<div class="fade-in space-y-8">

  {% if dashboard_mode %}
  <div class="flex items-center justify-between p-4 bg-gradient-to-r from-primary-600/10 to-transparent border border-primary-200 dark:border-primary-900 rounded-xl animate-pulse-slow">
        <div class="flex items-center">
            <span class="flex h-3 w-3 relative mr-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-primary-500"></span>
            </span>
            <div>
                <p class="text-primary-900 dark:text-primary-100 font-bold">Live Dashboard Active</p>
                <p class="text-xs text-primary-700 dark:text-primary-300">Prices Updated Just Now (Based on Saved Analysis from {{ last_updated }})</p>
            </div>
        </div>
        <a href="/" class="text-sm font-semibold text-primary-700 hover:text-primary-900 dark:text-primary-300 dark:hover:text-white hover:underline">
            <i class="bi bi-upload mr-1"></i> New Analysis
        </a>
  </div>
  {% endif %}

  <div class="relative overflow-hidden rounded-2xl shadow-xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 md:p-8">
      <div class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 rounded-full blur-3xl opacity-20
          {% if verdict_color == 'red' %}bg-red-500{% elif verdict_color == 'yellow' %}bg-yellow-500{% else %}bg-emerald-500{% endif %}"></div>

      <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
          <div>
              <p class="text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-1">Strategy Audit Verdict</p>
              <h2 class="text-4xl md:text-5xl font-extrabold tracking-tight
                 {% if verdict_color == 'red' %}text-red-600 dark:text-red-500{% elif verdict_color == 'yellow' %}text-yellow-600 dark:text-yellow-500{% else %}text-emerald-600 dark:text-emerald-500{% endif %}">
                 {{ verdict }}
              </h2>
              {% if verdict_details %}
                  <div class="mt-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200">
                      <i class="bi bi-info-circle-fill mr-2 opacity-75"></i> {{ verdict_details }}
                  </div>
              {% endif %}
          </div>

          <div class="flex flex-col items-end">
               {% if date_window %}
                <div class="text-right">
                    <span class="block text-xs text-gray-400 uppercase">Analysis Period</span>
                    <span class="font-mono text-sm text-gray-700 dark:text-gray-300">{{ date_window.start }} â€” {{ date_window.end }}</span>
                </div>
                {% endif %}
                <div class="mt-4">
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300">
                        {{ style|default('Standard')|title }} Profile
                     </span>
                </div>
          </div>
      </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

      <div class="relative group bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-lg transition-all">
          <div class="flex justify-between items-start">
              <div>
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Net PnL</p>
                  <h3 class="text-3xl font-bold mt-2 tracking-tight {% if strategy_metrics.total_pnl < 0 %}text-red-500{% else %}text-emerald-500{% endif %}">
                    ${{ "%.2f"|format(strategy_metrics.total_pnl) }}
                  </h3>
              </div>
              <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-gray-400 group-hover:text-primary-500 transition-colors">
                  <i class="bi bi-wallet2 text-xl"></i>
              </div>
          </div>
          <p class="mt-4 text-xs text-gray-400 font-mono">Fees Paid: ${{ "%.0f"|format(strategy_metrics.total_fees) }}</p>
      </div>

      <div class="relative group bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-lg transition-all">
          <div class="flex justify-between items-start">
              <div>
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Win Rate</p>
                  <h3 class="text-3xl font-bold mt-2 tracking-tight text-gray-900 dark:text-white">
                    {{ "%.1f"|format(strategy_metrics.win_rate * 100) }}%
                  </h3>
              </div>
              <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-gray-400 group-hover:text-blue-500 transition-colors">
                  <i class="bi bi-crosshair text-xl"></i>
              </div>
          </div>

          <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 mt-4">
            <div class="bg-blue-500 h-1.5 rounded-full" style="width: {{ strategy_metrics.win_rate * 100 }}%"></div>
          </div>
      </div>

      <div class="relative group bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-lg transition-all">
           <div class="flex justify-between items-start">
              <div>
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Expectancy / Trade</p>
                  <h3 class="text-3xl font-bold mt-2 tracking-tight {% if strategy_metrics.expectancy < 0 %}text-red-500{% else %}text-emerald-500{% endif %}">
                    ${{ "%.2f"|format(strategy_metrics.expectancy) }}
                  </h3>
              </div>
              <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-gray-400 group-hover:text-purple-500 transition-colors">
                  <i class="bi bi-graph-up-arrow text-xl"></i>
              </div>
          </div>
      </div>

      {% set bp_usage = buying_power_utilized_percent or 0 %}
      <div class="relative group bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-lg transition-all">
           <div class="flex justify-between items-start">
              <div>
                  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">BP Usage</p>
                  <h3 class="text-3xl font-bold mt-2 tracking-tight {% if bp_usage > 75 %}text-red-500{% else %}text-gray-900 dark:text-white{% endif %}">
                     {{ "%.0f"|format(bp_usage) }}%
                  </h3>
              </div>
              <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded-lg text-gray-400 group-hover:text-yellow-500 transition-colors">
                  <i class="bi bi-battery-half text-xl"></i>
              </div>
          </div>
          <p class="mt-4 text-xs text-gray-400">Target: &lt; 50%</p>
      </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
           <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Equity Curve</h3>
           <div class="h-64 w-full"><canvas id="portfolioChart"></canvas></div>
      </div>
      <div class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
           <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Monthly Income</h3>
           <div class="h-64 w-full"><canvas id="incomeChart"></canvas></div>
      </div>
  </div>

  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
          <h3 class="font-bold text-gray-900 dark:text-white">Active Positions</h3>
          <span class="bg-primary-100 text-primary-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-primary-900 dark:text-primary-300">{{ open_positions|length }} Open</span>
      </div>
      <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                  <tr>
                      <th class="px-6 py-3">Symbol</th>
                      <th class="px-6 py-3 text-right">Price</th>
                      <th class="px-6 py-3 text-center">Expiry</th>
                      <th class="px-6 py-3 text-right">Qty</th>
                      <th class="px-6 py-3 text-right">DTE</th>
                      <th class="px-6 py-3 text-center">Status</th>
                  </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                  {% for p in open_positions %}
                  <tr class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                      <td class="px-6 py-4 font-bold text-gray-900 dark:text-white">{{ p.symbol }}</td>
                      <td class="px-6 py-4 text-right">${{ "%.2f"|format(p.current_price) if p.current_price else '-' }}</td>
                      <td class="px-6 py-4 text-center">{{ p.expiry }}</td>
                      <td class="px-6 py-4 text-right font-mono {% if p.qty_open < 0 %}text-red-500{% else %}text-emerald-500{% endif %}">{{ "%.0f"|format(p.qty_open) }}</td>
                      <td class="px-6 py-4 text-right">
                           {% if p.dte is not none %}
                            <span class="{% if p.dte < 5 %}text-red-500 font-bold{% endif %}">{{ p.dte }}d</span>
                           {% else %}-{% endif %}
                      </td>
                      <td class="px-6 py-4 text-center">
                          {% if p.risk_alert %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">{{ p.risk_alert }}</span>
                          {% else %}
                            <span class="text-emerald-600 dark:text-emerald-400 text-xs"><i class="bi bi-check-circle"></i> OK</span>
                          {% endif %}
                      </td>
                  </tr>
                  {% else %}
                  <tr><td colspan="6" class="px-6 py-8 text-center italic">No active positions.</td></tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>

  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
           <h3 class="font-bold text-gray-900 dark:text-white">Strategy Performance</h3>
      </div>
      <div class="overflow-x-auto">
          <table id="strategyTable" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
               <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                  <tr>
                      <th class="px-6 py-3">Strategy</th>
                      <th class="px-6 py-3">Symbol</th>
                      <th class="px-6 py-3 text-right">Net PnL</th>
                      <th class="px-6 py-3 text-right">Daily PnL</th>
                  </tr>
              </thead>
              <tbody>
                  {% for s in strategy_groups %}
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border-b dark:border-gray-700">
                      <td class="px-6 py-4">
                          <div class="font-bold text-gray-900 dark:text-white">{{ s.strategy }}</div>
                          <div class="text-xs text-gray-400 mt-1">{{ s.legs_desc }}</div>
                      </td>
                      <td class="px-6 py-4">
                          <span class="bg-gray-100 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600">{{ s.symbol }}</span>
                      </td>
                      <td class="px-6 py-4 text-right font-bold {% if s.pnl < 0 %}text-red-500{% else %}text-emerald-500{% endif %}">
                          ${{ "%.2f"|format(s.pnl) }}
                      </td>
                      <td class="px-6 py-4 text-right font-mono">
                           ${{ "%.2f"|format(s.average_daily_pnl) }}
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>

  <div class="flex justify-center mt-8 pb-8">
    <a href="/download/{{ token }}/report.xlsx" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all hover:-translate-y-0.5 shadow-lg shadow-primary-500/30">
        <i class="bi bi-download mr-2"></i> Download Excel Report
    </a>
  </div>

</div>

<script>
    const isDark = document.documentElement.classList.contains('dark');
    // New Slate-themed colors for Charts
    const textColor = isDark ? '#94a3b8' : '#64748b'; // Slate-400 / Slate-500
    const gridColor = isDark ? '#334155' : '#e2e8f0'; // Slate-700 / Slate-200

    // Portfolio Curve Chart
    const portfolioData = {{ portfolio_curve | tojson }};
    if (portfolioData.length > 0) {
        new Chart(document.getElementById('portfolioChart'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Cumulative Net PnL ($)',
                    data: portfolioData,
                    borderColor: '#4f46e5', // Indigo-600
                    backgroundColor: 'rgba(79, 70, 229, 0.05)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#4f46e5'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                        grid: { color: gridColor, drawBorder: false },
                        ticks: { color: textColor, maxRotation: 0, autoSkip: true }
                    },
                    y: {
                        grid: { color: gridColor, drawBorder: false },
                        ticks: {
                            color: textColor,
                            callback: function(value) { return '$' + value; }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: isDark ? '#fff' : '#0f172a',
                        bodyColor: isDark ? '#cbd5e1' : '#475569',
                        borderColor: isDark ? '#334155' : '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 12 },
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return 'Cumulative: $' + context.parsed.y.toFixed(2);
                            },
                            afterBody: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                const item = portfolioData[index];
                                if (item && item.trades && item.trades.length > 0) {
                                    return '\nClosed Today:\n' + item.trades.join('\n');
                                }
                                return '';
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('portfolioChart').parentNode.innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400 italic">No data to display.</div>';
    }

    // Monthly Income Chart
    const incomeData = {{ monthly_income | tojson }};
    if (incomeData.length > 0) {
        new Chart(document.getElementById('incomeChart'), {
            type: 'bar',
            data: {
                labels: incomeData.map(d => d.month),
                datasets: [{
                    label: 'Net Income ($)',
                    data: incomeData.map(d => d.income),
                    // Emerald-500 / Danger-500 (Rose-500)
                    backgroundColor: incomeData.map(d => d.income >= 0 ? '#10b981' : '#f43f5e'),
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        grid: { color: gridColor, drawBorder: false },
                        ticks: {
                             color: textColor,
                             callback: function(value) { return '$' + value; }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: isDark ? '#fff' : '#0f172a',
                        bodyColor: isDark ? '#cbd5e1' : '#475569',
                        borderColor: isDark ? '#334155' : '#e2e8f0',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                             label: function(context) {
                                return 'Income: $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('incomeChart').parentNode.innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400 italic">No data to display.</div>';
    }

    // Initialize DataTables
    const dataTable = new simpleDatatables.DataTable("#strategyTable", {
        searchable: true,
        fixedHeight: false,
        perPage: 10,
        labels: {
            placeholder: "Search strategies...",
            perPage: "{select}",
            noRows: "No entries found",
            info: "{start}-{end} of {rows}",
        },
    });
</script>
{% endblock %}
