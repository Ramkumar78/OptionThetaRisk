{% extends "base.html" %}

{% block title %}Processing... - Trade Auditor{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 max-w-2xl text-center">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-8 border border-slate-200 dark:border-slate-700">
        <div class="mb-6">
            <div class="inline-block p-4 rounded-full bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 mb-4 animate-pulse">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cpu" viewBox="0 0 16 16">
                    <path d="M5 0a.5.5 0 0 1 .5.5h10a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5zM5.5 1h9v9h-9V1z"/>
                    <path d="M5.5 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Analyzing Your Trades</h1>
            <p class="text-slate-500 dark:text-slate-400">Please wait while we crunch the numbers. This usually takes 10-30 seconds.</p>
        </div>

        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6 overflow-hidden">
            <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 10%"></div>
        </div>

        <div id="statusMessage" class="text-sm font-medium text-slate-600 dark:text-slate-300">
            Initializing...
        </div>
    </div>
</div>

<form id="resultsForm" action="/analyze" method="POST" class="hidden">
    <!-- This is just a placeholder, actually we will redirect to /dashboard or handle the result display differently.
         Wait, /analyze usually renders results directly.
         If async, we might need to redirect to a results page that accepts the data or just /dashboard?
         The result of the task is the analysis dictionary.
         The task also saves the portfolio to DB.
         So we can redirect to /dashboard which loads from DB!
    -->
</form>

<script>
    const taskId = "{{ task_id }}";
    const progressBar = document.getElementById('progressBar');
    const statusMessage = document.getElementById('statusMessage');

    let progress = 10;

    function checkStatus() {
        fetch(`/job_status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.state === 'PENDING') {
                    statusMessage.innerText = 'Waiting in queue...';
                    progress = Math.min(progress + 1, 30);
                } else if (data.state === 'PROCESSING') {
                    statusMessage.innerText = 'Processing data...';
                    progress = Math.min(progress + 2, 90);
                } else if (data.state === 'SUCCESS' || data.result) {
                    statusMessage.innerText = 'Complete! Redirecting...';
                    progressBar.style.width = '100%';
                    // The task saves the portfolio to DB.
                    // So we can redirect to /dashboard to view it.
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 500);
                    return;
                } else if (data.state === 'FAILURE') {
                    statusMessage.innerText = 'Analysis Failed: ' + data.status;
                    statusMessage.classList.add('text-red-500');
                    return;
                }

                progressBar.style.width = progress + '%';
                setTimeout(checkStatus, 2000);
            })
            .catch(err => {
                console.error(err);
                statusMessage.innerText = 'Error checking status.';
                setTimeout(checkStatus, 5000);
            });
    }

    // Start polling
    setTimeout(checkStatus, 1000);

    // Auto-progress animation for visual comfort
    setInterval(() => {
        if (progress < 90) {
            progress += 0.5;
            progressBar.style.width = progress + '%';
        }
    }, 500);
</script>
{% endblock %}
