{% extends "base.html" %}

{% block title %}Screener Results - The Option Auditor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto fade-in">
    <!-- Header Card -->
    <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-sm border border-gray-200 dark:border-gray-800 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">Market Screener <span class="text-primary-600 dark:text-primary-400">Results</span></h2>
            <div class="flex flex-wrap items-center gap-3 mt-3 text-sm">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                    <i class="bi bi-graph-up-arrow mr-1.5"></i> Price > 50 SMA
                </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    <i class="bi bi-activity mr-1.5"></i> RSI < {{ rsi_threshold }}
                </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700">
                    <i class="bi bi-clock mr-1.5"></i> TF: {{ time_frame }}
                </span>
            </div>
        </div>
        <a href="/" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-gray-300 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:text-white transition-all shadow-sm">
            <i class="bi bi-arrow-left mr-2"></i> Back to Screener
        </a>
    </div>

    <!-- Candidates Banner -->
    {% if results and results|length > 0 %}
    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-2xl p-6 mb-8 border border-emerald-100 dark:border-emerald-800/50 shadow-sm relative overflow-hidden">
        <div class="relative z-10">
            <h3 class="text-lg font-bold text-emerald-800 dark:text-emerald-400 mb-2 flex items-center">
                <i class="bi bi-check-circle-fill mr-2"></i> CANDIDATES TO CHECK ON TASTYTRADE
            </h3>
            <p class="text-emerald-700 dark:text-emerald-300 text-sm mb-3">
                Review these symbols for high probability setups. Verify <strong>IV Rank > {{ iv_rank_threshold }}</strong> in your broker platform before trading.
            </p>
            <div class="bg-white/60 dark:bg-gray-900/60 backdrop-blur-sm rounded-lg p-3 border border-emerald-200 dark:border-emerald-800/50 inline-block">
                <p class="text-emerald-900 dark:text-emerald-100 font-mono font-medium">
                    {% set candidates = [] %}
                    {% for sector, rows in results.items() %}
                        {% for row in rows %}
                            {% if row.is_green %}
                                {% set _ = candidates.append(row.ticker) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    {{ candidates|join(', ') if candidates else 'No candidates found matching all criteria.' }}
                </p>
            </div>
        </div>
        <div class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-emerald-100/50 dark:from-emerald-900/30 to-transparent pointer-events-none"></div>
    </div>
    {% endif %}

    <div class="space-y-8">

        <!-- Sector Indices Section -->
        {% if sector_results %}
        <div class="bg-white dark:bg-gray-900 shadow-sm rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Sector Indices</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="sector-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th class="px-6 py-3">Sector</th>
                            <th class="px-6 py-3">Price</th>
                            <th class="px-6 py-3">1D %</th>
                            <th class="px-6 py-3">1W %</th>
                            <th class="px-6 py-3">ATR</th>
                            <th class="px-6 py-3">RSI (14)</th>
                            <th class="px-6 py-3">Trend</th>
                            <th class="px-6 py-3">Signal</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                        {% for row in sector_results %}
                        <tr class="bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                <div class="flex flex-col">
                                    <span class="font-bold">{{ row.ticker }}</span>
                                    {% if row.name %}
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ row.name }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 font-mono text-gray-900 dark:text-gray-300">
                                ${{ "%.2f"|format(row.price) }}
                            </td>
                            <td class="px-6 py-4 font-bold">
                                {% if row.pct_change_1d is not none %}
                                    <span class="{% if row.pct_change_1d >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                        {{ "%+.2f"|format(row.pct_change_1d) }}%
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 font-bold">
                                {% if row.pct_change_1w is not none %}
                                    <span class="{% if row.pct_change_1w >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                        {{ "%+.2f"|format(row.pct_change_1w) }}%
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">{{ "%.2f"|format(row.atr) }}</td>
                            <td class="px-6 py-4 font-mono {{ 'text-blue-600 font-bold' if row.rsi < 30 else '' }}">{{ "%.2f"|format(row.rsi) }}</td>
                            <td class="px-6 py-4">
                                <span class="px-2.5 py-0.5 text-xs font-semibold rounded-full
                                {% if row.trend == 'BULLISH' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                                    {{ row.trend }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                {% if "GREEN" in row.signal %}
                                    <span class="text-emerald-600 dark:text-emerald-400 font-bold flex items-center"><i class="bi bi-circle-fill text-[8px] mr-2"></i> BUY</span>
                                {% elif "OVERBOUGHT" in row.signal %}
                                    <span class="text-red-600 dark:text-red-400 font-bold">OVERBOUGHT</span>
                                {% else %}
                                    <span class="text-gray-500">Wait</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Individual Tickers Grouped by Sector -->
        {% if results and results|length > 0 %}
            {% for sector_name, rows in results.items() %}
            <div class="bg-white dark:bg-gray-900 shadow-sm rounded-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex items-center">
                    <span class="inline-flex items-center justify-center w-8 h-8 mr-3 text-xs font-bold text-primary-600 bg-primary-100 rounded-lg dark:text-primary-400 dark:bg-primary-900/50">
                        <i class="bi bi-pie-chart-fill"></i>
                    </span>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">{{ sector_name }}</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400 sortable-table">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th class="px-6 py-3">Ticker</th>
                                <th class="px-6 py-3">Price</th>
                                <th class="px-6 py-3">1D %</th>
                                <th class="px-6 py-3">1W %</th>
                                <th class="px-6 py-3">ATR</th>
                                <th class="px-6 py-3">P/E</th>
                            <th class="px-6 py-3" title="AI Reversal Confidence">AI Score</th>
                                <th class="px-6 py-3">IV Rank</th>
                                <th class="px-6 py-3">RSI (14)</th>
                                <th class="px-6 py-3">Trend</th>
                                <th class="px-6 py-3">Signal</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                            {% for row in rows %}
                            <tr class="bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors group">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white relative">
                                    <div class="flex flex-col">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-bold">{{ row.ticker }}</span>
                                        <button onclick="copyToClipboard('{{ row.ticker }}')"
                                                class="text-gray-400 hover:text-primary-500 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100"
                                                title="Copy Ticker">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                        <span class="text-xs text-gray-400 group-hover:text-primary-500 transition-colors">{{ row.company_name }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 font-mono text-gray-900 dark:text-gray-300">
                                    ${{ "%.2f"|format(row.price) }}
                                </td>
                                <td class="px-6 py-4 font-bold">
                                    {% if row.pct_change_1d is not none %}
                                        <span class="{% if row.pct_change_1d >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                            {{ "%+.2f"|format(row.pct_change_1d) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 font-bold">
                                    {% if row.pct_change_1w is not none %}
                                        <span class="{% if row.pct_change_1w >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                            {{ "%+.2f"|format(row.pct_change_1w) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">{{ "%.2f"|format(row.atr) }}</td>
                                <td class="px-6 py-4">{{ row.pe_ratio }}</td>
                                <td class="px-6 py-4 font-bold text-indigo-600 dark:text-indigo-400">{{ row.ai_confidence }}</td>
                                <td class="px-6 py-4" title="Check your broker for live IV Rank">
                                    <span class="text-gray-400 border-b border-dashed border-gray-400 cursor-help">{{ row.iv_rank }}</span>
                                </td>
                                <td class="px-6 py-4 font-mono {{ 'text-blue-600 font-bold' if row.rsi < 30 else '' }}">
                                    {{ "%.2f"|format(row.rsi) }}
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2.5 py-0.5 text-xs font-semibold rounded-full
                                    {% if row.trend == 'BULLISH' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                                        {{ row.trend }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    {% if "GREEN" in row.signal %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-bold bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200">
                                            <i class="bi bi-lightning-fill mr-1"></i> BUY
                                        </span>
                                    {% elif "OVERBOUGHT" in row.signal %}
                                        <span class="text-xs font-bold text-red-600 dark:text-red-400">OVERBOUGHT</span>
                                    {% else %}
                                        <span class="text-xs text-gray-500">Wait</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-20 bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800">
                <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-full inline-block mb-4">
                    <i class="bi bi-search text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-medium text-gray-900 dark:text-white">No matches found</h3>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Try adjusting your filters (RSI, Trend) or check back later.</p>
                <a href="/" class="mt-6 inline-block text-primary-600 hover:text-primary-700 font-semibold">Adjust Filters &rarr;</a>
            </div>
        {% endif %}

    </div>
</div>

<script>
    // Initialize simple-datatables for all tables
    document.addEventListener("DOMContentLoaded", function() {
        // Sector Indices Table
        const sectorTable = document.getElementById("sector-table");
        if (sectorTable) {
            new simpleDatatables.DataTable(sectorTable, {
                searchable: false,
                paging: false,
                fixedHeight: false
            });
        }

        // Individual Sector Tables
        const tables = document.querySelectorAll(".sortable-table");
        tables.forEach(t => {
            new simpleDatatables.DataTable(t, {
                searchable: true,
                fixedHeight: false,
                perPage: 10,
                labels: {
                    placeholder: "Search tickers...",
                    perPage: "entries per page",
                    noRows: "No entries found",
                    info: "Showing {start} to {end} of {rows} entries",
                }
            });
        });
    });
</script>
{% endblock %}
