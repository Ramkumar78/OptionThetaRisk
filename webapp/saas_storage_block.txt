class SaaSStorage(PostgresStorage):
    """
    SaaS Storage implementation.
    - Uses Postgres (via SQLAlchemy) for Metadata, Users, Portfolios.
    - Uses S3 for Large Reports and Temporary Uploads.
    """
    def __init__(self, db_url: str, bucket_name: str, region_name: str = None):
        super().__init__(db_url)
        self.bucket_name = bucket_name
        self.s3 = boto3.client('s3', region_name=region_name)

    def save_report(self, token: str, filename: str, data: bytes) -> None:
        """Saves report to S3 and metadata to DB."""
        # 1. Upload to S3
        key = f"reports/{token}/{filename}"
        self.s3.put_object(
            Bucket=self.bucket_name,
            Key=key,
            Body=data
        )

        # 2. Save metadata to DB (without data blob)
        # Note: Report.data is LargeBinary. We store the S3 Key there or nothing?
        # If we store nothing, get_report needs to know to fetch from S3.
        # We can overload the 'data' column to store "s3://..." string as bytes?
        # Or just rely on convention.

        # Let's store "s3:<key>" in the data column (as bytes) so we know where it is.
        s3_pointer = f"s3:{key}".encode('utf-8')

        session = self.Session()
        try:
            report = Report(token=token, filename=filename, data=s3_pointer)
            session.merge(report)
            session.commit()
        finally:
            session.close()

    def get_report(self, token: str, filename: str) -> bytes:
        """Retrieves report from S3."""
        # Check DB first to verify existence/expiration
        session = self.Session()
        s3_key = None
        try:
            report = session.query(Report).filter_by(token=token, filename=filename).first()
            if report and report.data:
                if report.data.startswith(b"s3:"):
                    s3_key = report.data.decode('utf-8')[3:]
                else:
                    return report.data # Legacy / Fallback
        finally:
            session.close()

        if s3_key:
            try:
                response = self.s3.get_object(Bucket=self.bucket_name, Key=s3_key)
                return response['Body'].read()
            except Exception:
                return None
        return None

    def save_upload(self, key: str, data: bytes) -> None:
        """Save upload to S3."""
        s3_key = f"uploads/{key}"
        self.s3.put_object(
            Bucket=self.bucket_name,
            Key=s3_key,
            Body=data
        )

    def get_upload(self, key: str) -> bytes:
        """Get upload from S3."""
        s3_key = f"uploads/{key}"
        try:
            response = self.s3.get_object(Bucket=self.bucket_name, Key=s3_key)
            return response['Body'].read()
        except Exception:
            return None
